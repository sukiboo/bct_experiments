"""
Create a dataset consisting of healthcare messages for behavioral change.
Messages are generated by gpt-3.5-turbo-0613 model from the templatized prompt.

BCT labels/definitions/examples are taken from the BCT Taxonomy v1 available at
https://digitalwellbeing.org/wp-content/uploads/2016/11/BCTTv1_PDF_version.pdf

Processed table with corrected grammar and extra info is available at
https://docs.google.com/spreadsheets/d/1a4Ntiwa1DLkpfAGDDrKvyyB4QA4xkKhQpD9kKx-DRck
"""

import pandas as pd
import openai
import os

openai.api_key = os.environ['OPENAI_API_KEY']


def generate_response(user_prompt,
                      system_prompt='You are a helpful assistant.',
                      model='gpt-3.5-turbo-0613',
                      temperature=0):
    """Submit user prompt to GPT model and return the response"""
    messages = [{'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}]
    response = openai.ChatCompletion.create(messages=messages,
                                            model=model,
                                            temperature=temperature)
    return response.choices[0].message.content



if __name__ == '__main__':

    prompt_file = 'baseline.txt'
    num_messages = 5


    # read BCT taxonomy
    BCT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS1NRUf8'\
              'ZMAowUBBqq69awHkuDY1ZQIQord5rbFlhHr8dcJUaQqQImEMJnhuwKtu'\
              'ASrU_cBtO7Omj9Q/pub?gid=970379036&single=true&output=csv'
    bcts = pd.read_csv(BCT_URL)

    # read the prompt
    with open(f'./inputs/{prompt_file}') as prompt:
        prompt = prompt.read().splitlines()[0]


    # generate dataset
    for i in range(9):
        bct_prompt = prompt.replace('{bct_label}', bcts.Label[i])\
                           .replace('{bct_definition}', bcts.Definition[i])\
                           .replace('{num_messages}', str(num_messages))
        print(f'\n{i+1}. {bct_prompt}')
        print(generate_response(bct_prompt))






